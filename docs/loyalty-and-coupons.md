# Loyalty Rewards & Coupon Platform

This guide documents the loyalty points program and coupon infrastructure introduced to Foodify's server. It covers how points are earned, how customers redeem them, available APIs, order payload changes, and the persistence model backing the feature set.

## Points Lifecycle
- Customers accrue loyalty points equal to 10% of the delivered order total. The calculation runs after the order lifecycle moves to `DELIVERED`, updates the client's stored balance, records a transaction entry, and caches the amount on the order for auditing.【F:src/main/java/com/foodify/server/modules/rewards/application/LoyaltyService.java†L35-L97】【F:src/main/java/com/foodify/server/modules/rewards/application/LoyaltyOrderEventListener.java†L23-L39】【F:src/main/java/com/foodify/server/modules/orders/domain/Order.java†L114-L126】
- Client profiles now persist a numeric `loyalty_points_balance` column (precision 19, scale 2) so rankings and future KPIs can query the latest available balance directly.【F:src/main/java/com/foodify/server/modules/identity/domain/Client.java†L29-L58】
- Every adjustment is stored in `loyalty_point_transactions` with the client, optional order reference, amount, free-form description, and a `type` enum (`EARNED`, `REDEEMED`, `ADJUSTMENT`).【F:src/main/resources/db/migration/V6__add_loyalty_and_coupons.sql†L38-L48】【F:src/main/java/com/foodify/server/modules/rewards/domain/LoyaltyPointTransaction.java†L15-L38】【F:src/main/java/com/foodify/server/modules/rewards/domain/LoyaltyPointTransactionType.java†L3-L7】
- The balance API (`GET /api/loyalty/points`) returns the current balance alongside lifetime earned and redeemed totals aggregated from the transaction ledger.【F:src/main/java/com/foodify/server/modules/rewards/api/LoyaltyController.java†L32-L37】【F:src/main/java/com/foodify/server/modules/rewards/dto/LoyaltyBalanceResponse.java†L5-L10】【F:src/main/java/com/foodify/server/modules/rewards/application/LoyaltyService.java†L100-L137】
- A separate feed (`GET /api/loyalty/points/transactions`) exposes the transaction history, including descriptive strings suitable for client UI audit trails.【F:src/main/java/com/foodify/server/modules/rewards/api/LoyaltyController.java†L39-L44】【F:src/main/java/com/foodify/server/modules/rewards/dto/LoyaltyTransactionDto.java†L8-L14】【F:src/main/java/com/foodify/server/modules/rewards/application/LoyaltyService.java†L126-L137】

## Redeeming Points for Coupons
- Customers can spend points on two coupon types: percentage discounts and free delivery.【F:src/main/java/com/foodify/server/modules/rewards/domain/CouponType.java†L3-L6】
- Free delivery coupons cost a flat 250 points, while percentage coupons cost 15 points per requested percent (e.g., a 10% coupon costs 150 points). Percentage coupons must request between 5% and 50%; the service rejects requests outside this window even though the request DTO allows 1–100% for validation friendliness.【F:src/main/java/com/foodify/server/modules/rewards/application/LoyaltyService.java†L35-L215】【F:src/main/java/com/foodify/server/modules/rewards/dto/RedeemCouponRequest.java†L12-L33】
- Redeemed coupons are minted as inactive-public records tied to the requesting client, marked with `createdFromPoints`, and immediately assigned so they appear in the user's wallet. The loyalty service logs a negative transaction to keep the ledger balanced.【F:src/main/java/com/foodify/server/modules/rewards/application/LoyaltyService.java†L139-L196】【F:src/main/java/com/foodify/server/modules/rewards/domain/Coupon.java†L21-L40】
- The redemption endpoint (`POST /api/loyalty/coupons/redeem`) requires a client token (`ROLE_CLIENT`) and returns the generated coupon descriptor (`code`, `type`, `assignedAt`, etc.).【F:src/main/java/com/foodify/server/modules/rewards/api/LoyaltyController.java†L46-L53】【F:src/main/java/com/foodify/server/modules/rewards/dto/CouponDto.java†L8-L17】

## Coupon Distribution & Redemption Rules
- Coupons live in a shared `coupons` table with flags for public availability, active status, and optional ownership metadata. Assignments and redemptions sit in join tables to enforce single-use per client.【F:src/main/resources/db/migration/V6__add_loyalty_and_coupons.sql†L1-L37】【F:src/main/java/com/foodify/server/modules/rewards/domain/Coupon.java†L21-L40】【F:src/main/java/com/foodify/server/modules/rewards/domain/CouponAssignment.java†L9-L28】【F:src/main/java/com/foodify/server/modules/rewards/domain/CouponRedemption.java†L9-L33】
- Public coupons appear for every client, but the service checks `coupon_redemptions` to hide already-used codes. Private coupons require an explicit assignment row; attempts to apply them by other users raise a `403`.【F:src/main/java/com/foodify/server/modules/rewards/application/CouponService.java†L54-L175】
- Redeeming a coupon attaches the order id to the redemption record (on first use) so finance and support teams can trace the exact transaction that consumed the benefit.【F:src/main/java/com/foodify/server/modules/rewards/application/CouponService.java†L107-L130】
- The wallet endpoint (`GET /api/loyalty/coupons`) merges active public coupons with assigned ones and includes flags for redemption status and whether the coupon originated from points, enabling client UIs to filter and badge entries.【F:src/main/java/com/foodify/server/modules/rewards/api/CouponController.java†L26-L31】【F:src/main/java/com/foodify/server/modules/rewards/application/CouponService.java†L132-L175】【F:src/main/java/com/foodify/server/modules/rewards/dto/CouponDto.java†L8-L17】

## Order Placement & Payload Changes
- Order requests can now supply an optional `couponCode`. When present, the order service validates the code against the caller, recalculates totals (including free-delivery overrides), clamps the discount to the pre-discount total, and stores the coupon reference plus discount on the order before persistence.【F:src/main/java/com/foodify/server/modules/orders/dto/OrderRequest.java†L17-L38】【F:src/main/java/com/foodify/server/modules/orders/application/CustomerOrderService.java†L289-L324】【F:src/main/java/com/foodify/server/modules/orders/domain/Order.java†L117-L126】
- Successful orders record the redemption so the same coupon cannot be reused by the client, even if the order lifecycle completes asynchronously.【F:src/main/java/com/foodify/server/modules/orders/application/CustomerOrderService.java†L289-L320】
- Order responses expose the applied coupon: both the synchronous placement response (`CreateOrderResponse`) and realtime notifications (`OrderNotificationDTO`) include the coupon code and discount amount within the payment summary payloads.【F:src/main/java/com/foodify/server/modules/orders/dto/response/CreateOrderResponse.java†L9-L49】【F:src/main/java/com/foodify/server/modules/orders/dto/OrderNotificationDTO.java†L10-L69】【F:src/main/java/com/foodify/server/modules/orders/mapper/OrderNotificationMapper.java†L68-L130】

## Database Summary
- Migration `V6__add_loyalty_and_coupons.sql` creates the coupon, assignment, redemption, and loyalty transaction tables, adds `loyalty_points_balance` to `app_users`, and augments orders with coupon metadata and `loyalty_points_earned` for downstream analytics.【F:src/main/resources/db/migration/V6__add_loyalty_and_coupons.sql†L1-L63】

Use this document as the source of truth when integrating client apps, analytics, or administrative tooling with the loyalty rewards platform.
